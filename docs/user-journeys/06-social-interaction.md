# 6. 社交互动与反馈

- **角色：** 已登录用户（点赞/评论/关注/分享）；评委/组织者（评分）
- **前置条件：** 已登录，目标内容对当前用户可见
- **关联测试：** `specs/testcases/25-social-interaction.md`

## 6.1 点赞

| 用户旅程 | 说明 | 数据操作 |
|---------|------|---------|
| 点赞帖子 | 对喜欢的帖子点赞 | `CREATE interaction`（type: like, target_type: post） |
| 取消点赞 | 取消之前的点赞 | `DELETE interaction`（type: like） |
| 查看点赞数 | 查看帖子的点赞统计 | `READ post`（like_count 缓存字段） |
| 查看点赞列表 | 查看自己点赞的所有内容 | `READ interaction`（type: like, created_by: current_user） |

## 6.2 收藏 (Bookmarking)

用户可以将感兴趣的内容加入收藏夹，便于日后查找。

| 用户旅程 | 说明 | 数据操作 |
|---------|------|---------|
| **收藏内容** | 点击帖子或提案详情页的**星形按钮**进行收藏 | `CREATE interaction` (type: bookmark) |
| 取消收藏 | 再次点击星形按钮取消收藏 | `DELETE interaction` (type: bookmark) |
| 查看收藏夹 | 在个人主页查看自己收藏的所有内容列表 | `READ interaction` (type: bookmark, created_by: current_user) |

## 6.3 评论

| 用户旅程 | 说明 | 数据操作 |
|---------|------|---------|
| 发表评论 | 对帖子发表评论 | `CREATE interaction`（type: comment） |
| **楼中楼回复** | 对已有评论进行回复，支持多级嵌套展示 | `CREATE interaction`（type: comment, parent_id） |
| 删除评论 | 删除自己发表的评论 | `DELETE interaction`（软删除） |
| 查看评论列表 | 查看帖子下的所有评论，前端按层级结构展示 | `READ interaction`（type: comment, target_id） |

## 6.4 评分

| 用户旅程 | 说明 | 数据操作 |
|---------|------|---------|
| 评委打分 | 评委对参赛帖子进行打分 | `CREATE interaction`（type: rating） |
| 修改评分 | 评委修改之前的评分 | `UPDATE interaction`（type: rating） |
| 查看平均分 | 查看帖子的平均评分 | `READ post`（average_rating 缓存字段） |

**约束：**
- 只有被指定为活动评委的用户才能打分
- 每个评委对同一帖子只能打一次分（可修改）
- 评分值需在规则定义的范围内

## 6.5 内容关注

| 用户旅程 | 说明 | 数据操作 |
|---------|------|---------|
| 关注提案 | 订阅特定提案的更新动态 | `CREATE interaction`（type: follow, target_type: post） |
| 关注团队 | 订阅特定团队的动态 | `CREATE interaction`（type: follow, target_type: group） |
| 关注活动 | 订阅特定活动的更新动态 | `CREATE interaction`（type: follow, target_type: event） |
| 关注用户 | 关注感兴趣的用户。**互相关注将自动成为好友** | `CREATE interaction`（type: follow, target_type: user） |
| 取消关注 | 取消对内容的关注 | `DELETE interaction`（type: follow） |
| 查看关注列表 | 查看自己关注的所有内容 | `READ interaction`（type: follow, created_by） |

**约束：**
- 不能关注自己创建的内容（或自己）
- 关注后收到内容更新通知
- **好友关系**：当用户 A 关注用户 B，且 B 也关注 A 时，两人自动成为**好友**。系统会发送“新好友”通知。好友关系在用户主页有特殊标识（如握手图标）。

## 6.6 分享

| 用户旅程 | 说明 | 数据操作 |
|---------|------|---------|
| 分享活动 | 将活动分享到外部社交媒体 | 生成分享链接/卡片 |
| 分享帖子 | 将帖子分享到外部社交媒体 | 生成分享链接/卡片 |
| 复制链接 | 复制内容链接到剪贴板 | 前端操作，无数据变更 |

**说明：**
- 分享功能主要是前端实现
- 私有内容分享链接需要权限验证

## 6.7 缓存字段维护

以下缓存字段由系统自动维护：

| 字段 | 更新触发 | 说明 |
|------|---------|------|
| `like_count` | 点赞/取消点赞时 | 帖子的点赞总数 |
| `comment_count` | 评论/删除评论时 | 帖子的评论总数 |
| `bookmark_count` | 收藏/取消收藏时 | 帖子的收藏总数 |
| `average_rating` | 评分/修改评分时 | 帖子的平均评分 |

## 6.8 通知体系 (Notification System)

系统通知分为四大类：互动通知、团队通知、资产通知和系统通知。

### 6.8.1 互动通知 (Interaction Notifications)
由社交互动触发，主要用于告知用户其内容受到的关注和反馈。

| 触发动作 | 通知接收者 | 通知内容 | 关联操作 |
|---------|-----------|---------|---------|
| 点赞 | 内容作者 | "{用户} 赞了你的{内容类型}" | 查看内容 |
| 收藏 | 内容作者 | "{用户} 收藏了你的{内容类型}" | 查看内容 |
| 评论 | 内容作者 | "{用户} 评论了你的{内容类型}" | 查看评论 |
| 回复 | 原评论者 | "{用户} 回复了你的评论" | 查看评论 |
| @提及 | 被提及者 | "{用户} 在{内容}中提到了你" | 查看提及处 |
| 关注 | 被关注者 | "{用户} 关注了你" | 查看主页 |
| **成为好友** | 双方用户 | "你和 {用户} 互相关注，成为好友啦！" | 查看好友主页 |

### 6.8.2 团队通知 (Team Notifications)
涉及团队成员变动和权限管理的通知。需审批的通知包含操作按钮。

| 触发动作 | 通知接收者 | 通知内容 | 交互按钮 | 后续系统行为 |
|---------|-----------|---------|---------|-------------|
| 申请加入 | 团队队长 | "{用户} 申请加入团队 {团队名}" | **[同意] [拒绝]** | 同意：用户加入，发结果通知<br>拒绝：发结果通知 |
| 邀请加入 | 被邀请用户 | "{队长} 邀请你加入团队 {团队名}" | **[接受] [拒绝]** | 接受：用户加入，通知队长<br>拒绝：通知队长 |
| 申请结果 | 申请人 | "你加入 {团队名} 的申请已被 {结果}" | - | - |
| 邀请结果 | 邀请人 | "{用户} 已 {结果} 加入团队邀请" | - | - |

### 6.8.3 资产通知 (Asset Notifications)
涉及资产所有权变更、复制、引用等敏感操作的通知。

| 触发动作 | 通知接收者 | 通知内容 | 交互按钮 | 后续系统行为 |
|---------|-----------|---------|---------|-------------|
| 收到资产 | 接收者 | "你收到了一份新资产：{资产名}" | [查看资产] | - |
| 申请复制 | 资产拥有者 | "{用户} 申请复制你的资产 {资产名}" | **[同意] [拒绝]** | 同意：系统为申请人创建副本<br>拒绝：通知申请人被拒 |
| 申请关联 | 提案拥有者 | "{用户} 请求将资产 {资产名} 关联到你的提案 {提案名}" | **[同意] [拒绝]** | 同意：建立 `post:resource` 关联<br>拒绝：通知申请人被拒 |
| 复制结果 | 申请人 | "复制资产 {资产名} 的申请已被 {结果}" | [查看副本] | - |
| 关联结果 | 申请人 | "资产关联请求已被 {结果}" | [查看提案] | - |

### 6.8.4 系统通知 (System Notifications)
平台发布的公告、警告或状态变更。

- 平台公告
- 违规警告
- 活动状态变更提醒

## 6.9 社交数据可见性 (Social Data Visibility)

社交维度的统计数据**对所有用户（包括访客）公开可见**，但具体列表受用户隐私设置控制：

| 数据指标 | 可见范围 | 说明 |
|---------|---------|------|
| **关注数/粉丝数** | 公开 (Public) | 用户个人主页显示的关注者数量和正在关注的数量 |
| **点赞数 (Likes)** | 公开 (Public) | 帖子、活动或评论获得的点赞总数 |
| **收藏数 (Bookmarks)** | 公开 (Public) | 内容被收藏的总次数 |
| **评论数 (Comments)** | 公开 (Public) | 内容下的评论总条数 |
| **好友/连接数** | 公开 (Public) | 用户的互相关注（好友）数量 |

## 6.10 异常与限制 (Constraints & Edge Cases)

| 场景 | 说明 | 系统行为 |
|------|------|---------|
| **用户拉黑 (Blocking)** | 用户 A 拉黑 用户 B | B **无法**关注、评论、点赞 A 的内容；B 无法查看 A 的个人主页（显示受限）；A 亦无法看到 B 的动态 |
| **内容删除** | 原帖被作者删除 | 关联的评论、点赞记录被**级联隐藏**（或软删除）；已转发/分享的链接失效 |
| **禁言/封号** | 用户被管理员封禁 | 用户发布的历史内容保留但**禁止互动**；用户无法进行任何写操作 (`CREATE/UPDATE/DELETE`) |
| **重复互动** | 短时间内高频操作 | 触发 Rate Limit，系统返回 `429 Too Many Requests`，限制操作 |
